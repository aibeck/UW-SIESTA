{% load static %}
{% load widget_tweaks %}
{% load env %}

<!doctype html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <script src="https://unpkg.com/htmx.org@1.2.1"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.6.0/umd/popper.min.js" integrity="sha512-BmM0/BQlqh02wuK5Gz9yrbe7VyIVwOzD1o40yi1IsTjriX/NGF37NyXHfmFzIlMmoSIBXgqDiG1VNU6kB5dBbA==" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/gh/ethereumjs/browser-builds/dist/ethereumjs-tx/ethereumjs-tx-1.3.3.min.js"></script>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="/static/admin/css/style.css">

    {% block page_meta %}
    {% endblock %}
</head>
<body>
	<div id="nav_container">
		<div class= 'sidebar'>

			<section><a href hx-get="{% url 'index' %}"
					hx-push-url="true" hx-target="#content" hx-swap="innerHTML"
					hx-indicator="#content-loader"><h1>Home</h1></a></section>

			<section><a href hx-get="{% url 'extract_features' %}" hx-push-url="true"
					hx-target="#content" hx-swap="innerHTML"
					hx-indicator="#content-loader"><h1>Feature Extraction</h1></a></section>

			<section><a href hx-get="{% url 'score_data' %}" hx-push-url="true"
					hx-target="#content" hx-swap="innerHTML"
					hx-indicator="#content-loader"><h1>Score Data</h1></a></section>

			<section><a href hx-get="{% url 'merge_data' %}" hx-push-url="true"
					hx-target="#content" hx-swap="innerHTML"
					hx-indicator="#content-loader"><h1>Merge Data</h1></a></section>

			<section><a href hx-get="{% url 'fit_model' %}" hx-push-url="true"
					hx-target="#content" hx-swap="innerHTML"
					hx-indicator="#content-loader"><h1>Fit New Model</h1></a></section>
		</div>

		<div id="content">
		{% block content %}
		{% endblock %}
		</div>

	</div>

<!-- Optional JavaScript -->
<!-- jQuery first, then Popper.js, then Bootstrap JS -->

<script type="text/javascript">
    const update_ms = 1000;

    function getCookie(name) {
        const cookieValue = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
        return cookieValue ? cookieValue.pop() : '';
    }

    function updateTimer(actionText, startTime) {
        var elapsedTime = Math.floor((Date.now() - startTime) / update_ms); // Calculate the elapsed time in seconds

        const minutes = Math.floor(elapsedTime / 60);
        const seconds = elapsedTime % 60;

        return `${actionText} time elapsed: ${padTo2Digits(minutes)}:${padTo2Digits(seconds)}`;
    }


    function download_file(task_id, download_url, filename, handleHeaders = false) {
    	$.ajax({
    		method: 'GET',
    		url: download_url,
    		data: {'task_id': task_id},

    		xhrFields: {
    			responseType: 'blob' // to avoid binary data being mangled on charset conversion
    		},

    		success: function (response, status, xhr) {
    			var disposition = xhr.getResponseHeader('Content-Disposition');
    			if (!filename && disposition && disposition.indexOf('attachment') !== -1) {
    				var filenameRegex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
    				var matches = filenameRegex.exec(disposition);
    				if (matches != null && matches[1]) filename = matches[1].replace(/['"]/g, '');
    			}

    			if (typeof window.navigator.msSaveBlob !== 'undefined') {
    				// IE workaround for "HTML7007: One or more blob URLs were revoked by closing the blob for which they were created. These URLs will no longer resolve as the data backing the URL has been freed."
    				window.navigator.msSaveBlob(response, filename);
    			} else {
    				var URL = window.URL || window.webkitURL;
    				var downloadUrl = URL.createObjectURL(response);

    				if (filename) {
    					// use HTML5 a[download] attribute to specify filename
    					var a = document.createElement("a");
    					// safari doesn't support this yet
    					if (typeof a.download === 'undefined') {
    						window.location.href = downloadUrl;
    					} else {
    						a.href = downloadUrl;
    						a.download = filename;
    						document.body.appendChild(a);
    						a.click();
    					}
    				} else {
    					window.location.href = downloadUrl;
    				}

    				setTimeout(function () {
    					URL.revokeObjectURL(downloadUrl);
    				}, 100); // cleanup
    			}

    			if (handleHeaders) {
                    var cacheNewModel = xhr.getResponseHeader('X-Cache-New-Model');
                    var modelName = xhr.getResponseHeader('X-Model-Name');

                    if (cacheNewModel && modelName) {
                        if (cacheNewModel) {
                            sessionStorage.setItem('modelBlob', modelName);
                        }
                    }
                }
    		},
    		error: function (response, status, xhr) {
    			alert(response["responseJSON"]["error"]);
    		}
    	});
    };

    function storeInSession(key, value) {
        sessionStorage.setItem(key, value);
    }


    function uploadFile(formData, onProgress) {
        return new Promise((resolve, reject) => {
            const xhr = new XMLHttpRequest();

            xhr.upload.addEventListener('progress', (event) => {
                if (event.lengthComputable) {
                    onProgress(event.loaded);
                }
            });

            xhr.onreadystatechange = function() {
                if (xhr.readyState === XMLHttpRequest.DONE) {
                    if (xhr.status === 200) {
                        resolve(JSON.parse(xhr.responseText));
                    } else {
                        reject(xhr.statusText);
                    }
                }
            };

            xhr.open('POST', '/upload-file/', true);
            xhr.setRequestHeader('X-CSRFToken', getCookie('csrftoken'));
            xhr.send(formData);
        });
    }

    function delay(ms) {
        return new Promise.resolve(setTimeout(resolve, ms));
    }

    function padTo2Digits(num) {
        return num.toString().padStart(2, '0');
    }
</script>
</body>
</html>
